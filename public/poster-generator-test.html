<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI 포스터 생성기 테스트</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', Arial, sans-serif; margin: 0; padding: 24px; background:#f7f7f7; }
    h1 { margin: 0 0 16px; }
    .card { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1 1 320px; }
    label { display:block; font-weight: 600; margin: 8px 0 6px; }
    input, select, textarea, button { font-size: 14px; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; }
    button { background: #ff6a00; color: #fff; border: none; cursor: pointer; }
    button.secondary { background: #444; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #ddd; margin:4px 6px 0 0; cursor:pointer; }
    .pill .dot { width:12px; height:12px; border-radius:50%; border:1px solid rgba(0,0,0,0.2); }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:12px; }
    .thumb { position:relative; border-radius:10px; overflow:hidden; border:1px solid #eee; background:#fafafa; }
    .thumb img { width:100%; height:240px; object-fit:cover; display:block; }
    .thumb .actions { display:flex; gap:8px; padding:10px; }
    .stack { position:relative; }
    .overlay { position:absolute; color:#fff; text-shadow: 0 1px 2px rgba(0,0,0,0.6); white-space:nowrap; }
    .muted { color:#888; font-size:12px; }
    .tags { margin-top:6px; }
    
    .purpose-pill { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 16px;
      border-radius: 20px;
      margin: 8px;
      display: inline-block;
      transition: all 0.3s ease;
    }
    .purpose-pill:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .purpose-pill small { 
      opacity: 0.9;
      font-size: 11px;
      line-height: 1.2;
    }
  </style>
</head>
<body>
  <h1>AI 포스터 생성기 테스트</h1>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>서버 주소</label>
        <input id="serverUrl" value="http://localhost:3000" />
      </div>
      <div class="col">
        <label>스타일</label>
        <select id="style">
          <option value="sns">SNS (1:1)</option>
          <option value="store_promo">매장 홍보 (4:5)</option>
          <option value="event">이벤트 (16:9)</option>
          <option value="premium">프리미엄 (3:4)</option>
        </select>
      </div>
      <!-- 이미지 모델은 gpt-image-1으로 고정 -->
      <div class="col">
        <label>이미지(선택: 분석/합성용)</label>
        <input id="imageFile" type="file" accept="image/*" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>브랜드명 *</label>
        <input id="brandName" placeholder="My Cafe" />
      </div>
      <div class="col">
        <label>대표 상품 *</label>
        <input id="mainProduct" placeholder="라떼" />
      </div>
      <div class="col">
        <label>슬로건</label>
        <input id="slogan" placeholder="따뜻한 공간, 특별한 시간" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>이벤트/연락처(선택)</label>
        <input id="contactInfo" placeholder="오픈 20% 할인 / 02-1234-5678" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>웹사이트</label>
        <input id="website" placeholder="www.example.com" />
      </div>
      <div class="col">
        <label>주소</label>
        <input id="address" placeholder="도로명 주소" />
      </div>
      <div class="col">
        <label>인스타그램</label>
        <input id="instagram" placeholder="@brand_account" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <button id="btnAnalyze" class="secondary">1) (옵션) 사진 분석 & 질문 받기</button>
      </div>
      <div class="col">
        <button id="btnLoadPresets">2) 기존 프리셋 불러오기</button>
      </div>
      <div class="col">
        <button id="btnLoadPurposePresets">2) 용도별 프리셋 불러오기 (새로운 시스템)</button>
      </div>
    </div>
  </div>

  <div class="card" id="presetsCard" style="display:none;">
    <h3>기존 프리셋 선택</h3>
    <div id="presets" class="tags"></div>
    <div class="muted">선택된 프리셋: <span id="selectedPreset">-</span></div>
  </div>

  <div class="card" id="purposePresetsCard" style="display:none;">
    <h3>포스터 용도 선택 (AI 자동 최적화)</h3>
    <div id="purposePresets" class="tags"></div>
    <div class="muted">선택된 용도: <span id="selectedPurpose">-</span></div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col">
        <button id="btnSingle">3) 선택 무드로 1종 생성</button>
      </div>
    </div>
  </div>

  <div class="card" id="analysisCard" style="display:none;"><pre id="analysisOut"></pre></div>

  <div class="card">
    <h3>결과</h3>
    <div id="output" class="grid"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    document.addEventListener('DOMContentLoaded', () => {
      // 페이지가 어느 포트에서 열리든 현재 origin을 기본 서버로 사용
      try { $('serverUrl').value = location.origin; } catch {}
      // 서버 자동 감지: origin 실패 시 4000 → 8080 폴백
      (async () => {
        const list = [location.origin, 'http://localhost:4000', 'http://localhost:8080'];
        for (const base of list){
          try {
            const r = await fetch(base + '/health');
            if (r.ok){ $('serverUrl').value = base; break; }
          } catch {}
        }
      })();
    });
    let imageAnalysis = null;
    let selectedPreset = null;
    let selectedPurpose = null;

    function toast(msg){ console.log(msg); }
    function buildOverlay(textLayout, w, h){
      const fr = document.createDocumentFragment();
      if (!textLayout) return fr;
      Object.keys(textLayout).forEach(k => {
        const t = textLayout[k];
        if (!t || !t.text) return;
        const el = document.createElement('div');
        el.className = 'overlay';
        el.textContent = t.text;
        el.style.left = (t.position.x * w) + 'px';
        el.style.top = (t.position.y * h) + 'px';
        el.style.fontSize = (t.font_size * 0.3) + 'px';
        el.style.fontWeight = (t.style === 'bold' ? 700 : 400);
        el.style.color = t.color || '#fff';
        fr.appendChild(el);
      });
      return fr;
    }

    async function analyze(){
      const file = $('imageFile').files[0];
      if (!file){ toast('이미지 없어서 분석 스킵'); return; }
      const fd = new FormData();
      fd.append('image', file);
      const url = $('serverUrl').value + '/api/posters/analyze-and-generate-posters';
      let data;
      try {
        const res = await fetch(url, { method: 'POST', body: fd });
        data = await res.json();
      } catch (e) {
        alert('분석 요청 실패: ' + e.message);
        return;
      }
      imageAnalysis = data.image_analysis;
      $('analysisCard').style.display = 'block';
      $('analysisOut').textContent = JSON.stringify(data, null, 2);
      // 프리필
      if (imageAnalysis?.main_products?.length){ $('mainProduct').value = imageAnalysis.main_products[0]; }
      if (imageAnalysis?.recommended_slogans?.length){ $('slogan').value = imageAnalysis.recommended_slogans[0]; }
    }

    async function loadPresets(){
      const url = $('serverUrl').value + '/api/posters/presets';
      const res = await fetch(url);
      const data = await res.json();
      const list = data.presets || [];
      const wrap = $('presets');
      wrap.innerHTML = '';
      list.forEach(p => {
        const btn = document.createElement('span');
        btn.className = 'pill';
        btn.title = p.label;
        btn.onclick = () => { selectedPreset = p; $('selectedPreset').textContent = p.label; };
        const dot1 = document.createElement('span'); dot1.className = 'dot'; dot1.style.background = p.colors[0];
        const dot2 = document.createElement('span'); dot2.className = 'dot'; dot2.style.background = p.colors[1];
        const dot3 = document.createElement('span'); dot3.className = 'dot'; dot3.style.background = p.colors[2];
        const label = document.createElement('span'); label.textContent = p.label;
        btn.append(dot1, dot2, dot3, label);
        wrap.appendChild(btn);
      });
      $('presetsCard').style.display = 'block';
    }

    async function loadPurposePresets(){
      try {
        const res = await fetch($('serverUrl').value + '/api/posters/purpose-presets');
        const data = await res.json();
        const presets = data.presets || [];
        
        const wrap = $('purposePresets');
        wrap.innerHTML = '';
        presets.forEach(p => {
          const btn = document.createElement('span');
          btn.className = 'pill purpose-pill';
          btn.title = p.description;
          btn.onclick = () => { 
            selectedPurpose = p; 
            $('selectedPurpose').textContent = p.label; 
            // 용도 선택 시 자동으로 스타일 설정
            if (p.key === 'event_announcement') $('style').value = 'event';
            else if (p.key === 'cafe_restaurant') $('style').value = 'store_promo';
            else if (p.key === 'personal_social') $('style').value = 'premium';
            else $('style').value = 'sns';
          };
          const dot1 = document.createElement('span'); dot1.className = 'dot'; dot1.style.background = p.colors[0];
          const dot2 = document.createElement('span'); dot2.className = 'dot'; dot2.style.background = p.colors[1];
          const dot3 = document.createElement('span'); dot3.className = 'dot'; dot3.style.background = p.colors[2];
          const label = document.createElement('span'); 
          label.innerHTML = `<strong>${p.label}</strong><br><small>${p.description}</small>`;
          btn.append(dot1, dot2, dot3, label);
          wrap.appendChild(btn);
        });
        $('purposePresetsCard').style.display = 'block';
      } catch (e) {
        alert('용도별 프리셋 로드 실패: ' + e.message);
      }
    }

    function buildUserInputs(){
      return {
        brand_name: $('brandName').value.trim(),
        main_product: $('mainProduct').value.trim(),
        slogan: $('slogan').value.trim(),
        contact_info: $('contactInfo').value.trim(),
        website: $('website').value.trim(),
        address: $('address').value.trim(),
        instagram: $('instagram').value.trim()
      };
    }

    function ensureRequired(u){
      if (!u.brand_name || !u.main_product) throw new Error('브랜드명과 대표 상품은 필수입니다.');
    }

    function cardForPoster(title, bgUrl, bgB64, textLayout){
      const div = document.createElement('div');
      div.className = 'thumb';
      const stack = document.createElement('div');
      stack.className = 'stack';
      stack.style.width = '100%';
      stack.style.height = '240px';
      const img = document.createElement('img');
      img.src = bgUrl ? bgUrl : `data:image/webp;base64,${bgB64}`;
      img.onload = () => {
        const w = img.clientWidth; const h = img.clientHeight;
        stack.appendChild(buildOverlay(textLayout, w, h));
      };
      stack.appendChild(img);
      div.appendChild(stack);
      const actions = document.createElement('div');
      actions.className = 'actions';
      const dl = document.createElement('button');
      dl.textContent = '다운로드';
      dl.onclick = () => {
        const server = $('serverUrl').value;
        const params = bgUrl ? ('url=' + encodeURIComponent(bgUrl)) : ('b64=' + encodeURIComponent(bgB64));
        const a = document.createElement('a');
        a.href = `${server}/api/posters/download?${params}&filename=poster.webp`;
        a.click();
      };
      actions.appendChild(dl);
      const cap = document.createElement('div');
      cap.className = 'muted';
      cap.textContent = title;
      div.appendChild(actions);
      div.appendChild(cap);
      return div;
    }

    async function generateSingle(){
      const u = buildUserInputs(); ensureRequired(u);
      const file = $('imageFile').files[0];
      const hasImage = !!file;
      const out = $('output'); out.innerHTML = '';

      if (hasImage) {
        // 합성 경로: 원본 위 텍스트 오버레이(애프터만 표시)
        const fd = new FormData();
        fd.append('image', file);
        fd.append('style', $('style').value);
        if (selectedPreset) fd.append('preset_key', selectedPreset.key);
        fd.append('user_inputs', JSON.stringify(u));
        if (imageAnalysis) fd.append('image_analysis', JSON.stringify(imageAnalysis));
        let data;
        try {
          const res = await fetch($('serverUrl').value + '/api/posters/generate-single-composite', { method:'POST', body: fd });
          data = await res.json();
        } catch(e){ alert('합성 실패: ' + e.message); return; }
        // 애프터만 표시
        out.appendChild(cardForPoster(data.selected_preset?.label || 'After', null, data.after_b64, null));
      } else {
        // 이미지 생성 경로: gpt-image-1로 배경 생성 + 규칙 오버레이 미리보기
        const url = $('serverUrl').value + '/api/posters/generate-single';
        const body = { 
          style: $('style').value, 
          preset_key: selectedPreset ? selectedPreset.key : undefined, 
          purpose_key: selectedPurpose ? selectedPurpose.key : undefined,
          user_inputs: u, 
          image_analysis: imageAnalysis || undefined 
        };
        let data;
        try {
          const res = await fetch(url, { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(body) });
          data = await res.json();
        } catch (e) { alert('생성 요청 실패: ' + e.message); return; }
        const title = data.selected_purpose?.label || data.selected_preset?.label || '선택 무드';
        out.appendChild(cardForPoster(title, data.poster.background_url, data.poster.background_b64, data.poster.text_layout));
      }
    }

    $('btnAnalyze').onclick = () => {
      $('btnAnalyze').disabled = true; analyze().finally(() => $('btnAnalyze').disabled = false);
    };
    $('btnLoadPresets').onclick = () => {
      $('btnLoadPresets').disabled = true; loadPresets().finally(() => $('btnLoadPresets').disabled = false);
    };
    $('btnLoadPurposePresets').onclick = () => {
      $('btnLoadPurposePresets').disabled = true; loadPurposePresets().finally(() => $('btnLoadPurposePresets').disabled = false);
    };
    $('btnSingle').onclick = () => {
      $('btnSingle').disabled = true; generateSingle().finally(() => $('btnSingle').disabled = false);
    };
    // batch 제거
  </script>
</body>
</html>



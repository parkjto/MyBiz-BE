<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyBiz ì´ë¯¸ì§€ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .header { 
            text-align: center; 
            color: #333; 
            margin-bottom: 30px; 
        }
        .upload-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 2px dashed #007bff; 
            border-radius: 8px; 
            text-align: center; 
            background: #f8f9fa; 
        }
        .upload-area { 
            padding: 40px; 
            cursor: pointer; 
            transition: all 0.3s; 
        }
        .upload-area:hover { 
            background: #e9ecef; 
            border-color: #0056b3; 
        }
        .upload-area.dragover { 
            background: #d4edda; 
            border-color: #28a745; 
        }
        .file-input { 
            display: none; 
        }
        .btn { 
            background: #007bff; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 10px; 
            font-size: 16px; 
        }
        .btn:hover { 
            background: #0056b3; 
        }
        .btn-success { 
            background: #28a745; 
        }
        .btn-warning { 
            background: #ffc107; 
            color: #212529; 
        }
        .btn:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .result-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            display: none; 
        }
        .image-comparison { 
            display: flex; 
            gap: 20px; 
            margin: 20px 0; 
            flex-wrap: wrap; 
        }
        .image-box { 
            flex: 1; 
            min-width: 300px; 
            text-align: center; 
        }
        .image-box img { 
            max-width: 100%; 
            height: auto; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            max-height: 400px; 
        }
        .stats { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 15px 0; 
        }
        .loading { 
            text-align: center; 
            padding: 20px; 
            display: none; 
        }
        .spinner { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #007bff; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 10px; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .error { 
            background: #f8d7da; 
            border: 1px solid #f5c6cb; 
            color: #721c24; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 15px 0; 
            display: none; 
        }
        .success { 
            background: #d4edda; 
            border: 1px solid #c3e6cb; 
            color: #155724; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 15px 0; 
            display: none; 
        }
        .warning { 
            background: #fff3cd; 
            border: 1px solid #ffeaa7; 
            color: #856404; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 15px 0; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ–¼ï¸ MyBiz ì´ë¯¸ì§€ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</h1>
            <p>ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ë³´ì • ê²°ê³¼ë¥¼ ë°”ë¡œ í™•ì¸í•˜ì„¸ìš”!</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" class="file-input" accept="image/*">
                <h3>ğŸ“ ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</h3>
                <p>ì§€ì› í˜•ì‹: JPG, PNG, WebP (ìµœëŒ€ 5MB)</p>
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    íŒŒì¼ ì„ íƒ
                </button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
        </div>

        <div class="error" id="error"></div>

        <div class="result-section" id="resultSection">
            <h2>âœ… ì´ë¯¸ì§€ ë³´ì • ì™„ë£Œ!</h2>
            
            <div class="image-comparison">
                <div class="image-box">
                    <h3>ì›ë³¸ ì´ë¯¸ì§€</h3>
                    <img id="originalImage" alt="ì›ë³¸ ì´ë¯¸ì§€">
                    <p id="originalInfo"></p>
                </div>
                <div class="image-box">
                    <h3>ë³´ì •ëœ ì´ë¯¸ì§€</h3>
                    <img id="enhancedImage" alt="ë³´ì •ëœ ì´ë¯¸ì§€">
                    <p id="enhancedInfo"></p>
                </div>
            </div>

            <div class="stats" id="stats"></div>

            <div class="warning">
                <h3>âš ï¸ ì¤‘ìš” ì•ˆë‚´ì‚¬í•­</h3>
                <p><strong>ë³´ì •ëœ ì´ë¯¸ì§€ëŠ” ì„œë²„ì— ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤!</strong></p>
                <p>ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.</p>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-success" onclick="downloadEnhancedImage()">
                    ğŸ’¾ ë³´ì •ëœ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                </button>
                <button class="btn btn-warning" onclick="resetForm()">
                    ğŸ”„ ìƒˆë¡œ ì‹œì‘
                </button>
            </div>
        </div>

        <div class="warning">
            <h3>ğŸ“± ì‚¬ìš© ë°©ë²•</h3>
            <ol>
                <li>ìœ„ì˜ "íŒŒì¼ ì„ íƒ" ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”</li>
                <li>ì´ë¯¸ì§€ê°€ ìë™ìœ¼ë¡œ ì—…ë¡œë“œë˜ê³  ë³´ì •ë©ë‹ˆë‹¤</li>
                <li>ë³´ì • ê²°ê³¼ë¥¼ ë¹„êµí•˜ê³  ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”</li>
                <li>ëª¨ë“  ë°ì´í„°ëŠ” ì„œë²„ì— ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</li>
            </ol>
        </div>

        <div class="result-section" style="display: block;">
            <h3>ğŸ”§ ë””ë²„ê¹… ë„êµ¬</h3>
            <button class="btn" onclick="testJavaScript()">JavaScript í…ŒìŠ¤íŠ¸</button>
            <button class="btn" onclick="checkElements()">DOM ìš”ì†Œ í™•ì¸</button>
            <div id="debugInfo" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;"></div>
        </div>
    </div>

    <script>
        let enhancedImageData = null;
        let originalFileName = '';

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í™•ì¸
        document.addEventListener('DOMContentLoaded', function() {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œì‘');
            
            // íŒŒì¼ ì…ë ¥ ì²˜ë¦¬
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                console.log('fileInput ìš”ì†Œ ì°¾ìŒ, ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                fileInput.addEventListener('change', handleFileSelect);
            } else {
                console.error('fileInput ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                console.log('uploadArea ìš”ì†Œ ì°¾ìŒ, ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('drop', handleDrop);
                uploadArea.addEventListener('dragleave', handleDragLeave);
            } else {
                console.error('uploadArea ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            console.log('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
        });

        function handleFileSelect(event) {
            console.log('íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ë°œìƒ:', event);
            const file = event.target.files[0];
            console.log('ì„ íƒëœ íŒŒì¼:', file);
            if (file) {
                console.log('íŒŒì¼ ì²˜ë¦¬ ì‹œì‘:', file.name, file.size, file.type);
                processImage(file);
            } else {
                console.log('íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•ŠìŒ');
                showError('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processImage(files[0]);
            }
        }

        function handleDragLeave(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function processImage(file) {
            console.log('processImage í•¨ìˆ˜ í˜¸ì¶œë¨:', file);
            
            // íŒŒì¼ ê²€ì¦
            if (!file.type.startsWith('image/')) {
                console.log('ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹˜:', file.type);
                showError('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                console.log('íŒŒì¼ í¬ê¸° ì´ˆê³¼:', file.size);
                showError('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            console.log('íŒŒì¼ ê²€ì¦ í†µê³¼, ì²˜ë¦¬ ì‹œì‘');
            
            // ì›ë³¸ ì´ë¯¸ì§€ í‘œì‹œ
            displayOriginalImage(file);
            
            // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ë³´ì •
            uploadAndEnhance(file);
        }

        function displayOriginalImage(file) {
            console.log('displayOriginalImage í•¨ìˆ˜ í˜¸ì¶œë¨:', file);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('FileReader ë¡œë“œ ì™„ë£Œ:', e.target.result.substring(0, 100) + '...');
                document.getElementById('originalImage').src = e.target.result;
                document.getElementById('originalInfo').textContent = 
                    `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                console.log('ì›ë³¸ ì´ë¯¸ì§€ í‘œì‹œ ì™„ë£Œ');
            };
            reader.onerror = function(error) {
                console.error('FileReader ì—ëŸ¬:', error);
                showError('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + error.message);
            };
            reader.readAsDataURL(file);
            originalFileName = file.name;
            console.log('ì›ë³¸ íŒŒì¼ëª… ì„¤ì •:', originalFileName);
        }

        async function uploadAndEnhance(file) {
            showLoading(true);
            hideError();
            hideResult();

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/api/ad/enhance-image', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.ok) {
                    enhancedImageData = result.enhancedImage;
                    displayResult(result);
                } else {
                    showError(`ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨: ${result.message}`);
                }
            } catch (error) {
                showError(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function displayResult(result) {
            // ë³´ì •ëœ ì´ë¯¸ì§€ í‘œì‹œ
            document.getElementById('enhancedImage').src = `data:image/webp;base64,${result.enhancedImage}`;
            
            // í†µê³„ ì •ë³´ í‘œì‹œ
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                <h3>ğŸ“Š ì´ë¯¸ì§€ ì²˜ë¦¬ í†µê³„</h3>
                <ul>
                    <li><strong>ì›ë³¸ í¬ê¸°:</strong> ${(result.originalSize / 1024).toFixed(1)} KB</li>
                    <li><strong>ë³´ì • í›„ í¬ê¸°:</strong> ${(result.enhancedSize / 1024).toFixed(1)} KB</li>
                    <li><strong>ì••ì¶•ë¥ :</strong> ì•½ ${((1 - result.enhancedSize / result.originalSize) * 100).toFixed(1)}% ê°ì†Œ</li>
                    <li><strong>ì¶œë ¥ í˜•ì‹:</strong> WebP (í’ˆì§ˆ 88%)</li>
                </ul>
            `;

            // ë³´ì •ëœ ì´ë¯¸ì§€ ì •ë³´
            document.getElementById('enhancedInfo').textContent = 
                `ë³´ì •ëœ ì´ë¯¸ì§€ (${(result.enhancedSize / 1024).toFixed(1)} KB)`;

            showResult();
        }

        function downloadEnhancedImage() {
            if (!enhancedImageData) {
                showError('ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Base64ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
            const byteCharacters = atob(enhancedImageData);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'image/webp' });

            // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `enhanced_${originalFileName.replace(/\.[^/.]+$/, '')}.webp`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function resetForm() {
            document.getElementById('fileInput').value = '';
            document.getElementById('originalImage').src = '';
            document.getElementById('enhancedImage').src = '';
            document.getElementById('originalInfo').textContent = '';
            document.getElementById('enhancedInfo').textContent = '';
            document.getElementById('stats').innerHTML = '';
            hideResult();
            hideError();
            enhancedImageData = null;
            originalFileName = '';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showResult() {
            document.getElementById('resultSection').style.display = 'block';
        }

        function hideResult() {
            document.getElementById('resultSection').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // ë””ë²„ê¹… í•¨ìˆ˜ë“¤
        function testJavaScript() {
            console.log('JavaScript í…ŒìŠ¤íŠ¸ ë²„íŠ¼ í´ë¦­ë¨');
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML = `
                <strong>âœ… JavaScript ì •ìƒ ì‘ë™!</strong><br>
                <strong>í˜„ì¬ ì‹œê°„:</strong> ${new Date().toLocaleString()}<br>
                <strong>íŒŒì¼ ì…ë ¥ ìš”ì†Œ:</strong> ${document.getElementById('fileInput') ? 'ì°¾ìŒ' : 'ì°¾ì„ ìˆ˜ ì—†ìŒ'}<br>
                <strong>ì—…ë¡œë“œ ì˜ì—­:</strong> ${document.getElementById('uploadArea') ? 'ì°¾ìŒ' : 'ì°¾ì„ ìˆ˜ ì—†ìŒ'}
            `;
        }

        function checkElements() {
            console.log('DOM ìš”ì†Œ í™•ì¸ ë²„íŠ¼ í´ë¦­ë¨');
            const debugInfo = document.getElementById('debugInfo');
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            
            debugInfo.innerHTML = `
                <strong>ğŸ” DOM ìš”ì†Œ ìƒíƒœ:</strong><br>
                <strong>fileInput:</strong> ${fileInput ? 'ì¡´ì¬í•¨ (ID: ' + fileInput.id + ')' : 'ì¡´ì¬í•˜ì§€ ì•ŠìŒ'}<br>
                <strong>uploadArea:</strong> ${uploadArea ? 'ì¡´ì¬í•¨ (ID: ' + uploadArea.id + ')' : 'ì¡´ì¬í•˜ì§€ ì•ŠìŒ'}<br>
                <strong>ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ:</strong> ${fileInput && fileInput.onchange ? 'ì„¤ì •ë¨' : 'ì„¤ì •ë˜ì§€ ì•ŠìŒ'}
            `;
        }
    </script>
</body>
</html>
